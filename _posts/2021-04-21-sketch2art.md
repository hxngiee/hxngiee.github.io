---
layout: post
title: Sketch2Art - 작성중  
subtitle: Creating Artistic Images from Freehand Sketches 
thumbnail-img: /assets/img/projects_sketch2art.png 
gh-repo: sketch2art 
# gh-repo: daattali/beautiful-jekyll 
gh-badge: [star, fork, follow] 
tags: [Project, Image-to-Image Translation]
comments: true
---

{: .box-note}
**진행기간:** 2021.03 ~ 진행 중  
**Team:** 김기홍, 김정윤, 이건호  
**주요내용:** 소통 약자의 감정 표현과 창작 의도를 용이하게 전달해주는 자동 스케치 채색 및 스타일링 툴 개발  
**기여한 점:** Unsupervised Image-to-Image Translation Model에 Positional Normalization 적용하여 baseline 모델 성능 향상, Input 이미지의 Content 보존을 위한 Masking Module 적용, Flask를 이용한 Pytorch 모델 배포  
**사용한 Skill 또는 지식:** Pytorch, Flask, Unsupervised Image-to-Image Translation  


## Table of contents
- [Image Translation](#image-translation)
- [Problem Definition](#problem-definition)
- [Data Processing](#data-processing)
- [Model Training](#model-training)
- [Model Serving](#model-serving)
- [Future Work](#future-work)  


## Image Translation

<center>
<img src="/assets/img/sketch2art-imagetranslation.png" alt="Component model visualisation">
</center>  

 Image Translation 모델을 개발하고 본 모델을 활용한 어플리케이션을 제작하였습니다. Image translation이란 특정 domain의 이미지를 다른 domain의 이미지로 바꾸는 작업을 의미합니다. Image translation을 활용한 어플리케이션으로 동물의 종을 변화시키는 Animal translation(horse2zebra), Label map을 실제 사진으로 만드는 Semantic Image Synthesis(SPADE) 등이 있습니다. 이번 포스트에서는 Sketch 이미지를 painting 이미지로 변환하는 Image Translation 모델 제작 과정을 공유하고 이를 서비스로 구체화시키며 느낀 경험에 대해 이야기하고자 합니다

## Problem Definition  
- Style Transfer  
    - pre-trained 네트워크를 이용한 영상 최적화 방식
    - 새롭게 합성될 영상의 feature map이 Content/Style Image로부터 나온 feature map과 비슷한 특성을 갖도록 근사
- GAN  
    - 이미지 데이터의 확률 분포를 근사하는 모델 학습 방식  
    - 특정 Domain의 데이터를 다른 Domain의 데이터로 변환하는 Mapping Funtion 학습
    - Sampling을 통해 실존하지 않지만 있을 법한 이미지 생성  

 Sketch를 Painting으로 바꿔주는 Image Translation 모델은 이미지 생성 방식에 따라 두 분류로 나눌 수 있습니다. Style Transfer를 이용한 방식과 GAN을 이용한 방식이 그 예입니다. Style Transfer의 경우, pre-train 네트워크를 이용한 **영상 최적화** 방식으로 새롭게 합성될 영상의 feature map이 Content/Style Image로부터 나온 feature map과 비슷한 특성을 갖도록 근사합니다. 반면, GAN의 경우 **특정 Domain 데이터의 확률 분포를 근사**하는 모델 학습 방식으로 다른 Domain의 데이터로 변환하는 Mapping Function을 학습합니다. 두 방법은 이미지 자체에서 optimization을 진행하는지 혹은 Domain별 데이터의 확률분포를 바탕으로 optimization 진행하는지에 따라 차이를 보입니다

### 기존 Style Transfer의 문제점
<center>
<img src="/assets/img/sketch2art-styletransfer.png" alt="Component model visualisation">
</center>  
 일반적으로 Photo-realistic 이미지를 대상으로한 Style Transfer 모델은 Sketch 이미지에 대해 효과적으로 Stylize 할 수 없는 것을 발견했습니다. Sketch 이미지의 경우 그리고자 하는 Object의 정보가 많지 않아 여백 공간에 Style이나 Color를 단순하게 Mapping하는 문제가 발생했습니다. 이는 추가로 실험한 스케치+채색, 스케치+노이즈 케이스를 통해서 보다 명확히 이해할 수 있었습니다.

### Visualize Photo/Sketch Feature Map
<center>
<img src="/assets/img/sketch2art-feature_map.png" alt="Component model visualisation">
</center>  

 Photo-realistic 이미지와와 Sketch 이미지의 Feature Map을 시각화한 결과입니다. 일반 사진의 경우, 고양이 객체 뿐만아니라 이미지를 구성하고 있는 배경에서도 다양한 요소가 활성화 되어있습니다. 반면, Sketch 이미지의 경우, Edge line 주변에서 활성화 되거나 활성화 되는 부위가 없거나 Edge line을 제외한 모든 영역이 한번에 활성화되는 것을 볼 수 있습니다. 이는 기존 Feature Map Optimize 방식인 Style Transfer가 Sketch 이미지를 효과적으로 Stylize할 수 없다는 것을 뜻합니다.  
 
 실험 결과에 따라 Sketch 이미지 적절하게 Stylize하기 위해 GAN을 이용한 Image Translation 모델을 사용했습니다. 
 
## Data Processing
- Sketch Data는 Object의 Edge를 바탕으로 구성된 흑백 이미지로 딥러닝 학습에 필요한 데이터의 양이 충분치 않음
- 일반적으로 많이 알려진 pix2pix의 edges2shoes, edges2handbags의 경우, 다수의 dataset(5만개, 13만개)이 존재하나 새로운 카테고리에 대한 Sketch를 구하고자 할 경우, 해당 카테고리에 대한 Edge Detection과 Post-Processing 작업이 필요
- 본 글에서는 Semantic Segmentation 네트워크(DeepLabv3 사용)를 이용하여 일반 사진으로부터 특정 class에 대한 이미지를 검출/가공하고 해당 이미지를 딥러닝 학습에 적용하기 위한 절차를 서술

<center>
<p style="width:50%;height:400px;float:left;overflow:hidden;">
<img alt="1" src="/assets/img/sketch2art-photo.jpg"  style="height:100%;"/>
</p>
<p style="width:50%;height:400px;overflow:hidden;">
<img alt="2" src="/assets/img/sketch2art-bgsketch.png"  style="height:100%;"/>
</p>
<em> Left : afhq 고양이 사진 이미지 / Right : 일반 Canny를 적용한 사진</em>
</center>  

<br>

1. Sketch Object 선정  
Semantic Segmentation Network로부터 얻고자하는 class 지정하여, 이미지에서 특정 class의 pixel만 검출해내는 binary Segmentation map 확보

2. Background 이미지 제거  
binary Segmentation map을 Mask 이미지로 사용하여 곱연산을 통해 background 이미지 제거

<center>
<img src="/assets/img/sketch2art-photo_res.png" alt="Component model visualisation">
</center> 

3. 흑백 반전  
스케치 특성을 반영한 이미지를 만들기 위해 흑백 반전

<center>
<p style="width:50%;height:400px;float:left;overflow:hidden;">
<img alt="1" src="/assets/img/sketch2art-fgphoto.jpg"  style="height:100%;"/>
</p>
<p style="width:50%;height:400px;overflow:hidden;">
<img alt="2" src="/assets/img/sketch2art-sketch.jpg"  style="height:100%;"/>
</p>
<em> Left : 배경을 제거한 고양이 사진 이미지 / Right : 배경이 제거된 사진에 Canny를 적용한 이미지 </em>
</center>  

<br>

4. Guassian blur -> blur, Aperature  
Guassian blur를 통해 노이즈를 제거하고 Canny파라미터 조절을 통해

5. 이미지 Erosion과 Dilation

6. 공백 이미지 제거  
PyTorch를 이용하여 모델학습시 Input Tensor가 NaN or INF가 되는 경우가 존재하는데, Input Tensor가 Nan(or Infinite)이 될 경우, backpropagation 과정에서 문제가 발생하여 모델이 Blackout 됨. 따라서 전처리를 거친 data중 NaN or INF 이미지가 없는지 검증하는 절차가 필요


<center>
<img src="/assets/img/sketch2art-blank.png" alt="Component model visualisation">
</center>  

<center>
<img src="/assets/img/sketch2art-sketch_res.png" alt="Component model visualisation">
</center>

## Model Training
- MUNIT

## Model Serving

## Prototype

<center>
<img src="/assets/img/sketch2art-prototype.jpg" alt="Component model visualisation">
</center>  

## Future Work

<center>
<img src="/assets/img/sketch2art-service__architecture.png" alt="Component model visualisation">
</center>  

 실제 사람이 그린 Sketch 이미지는 사진의 Edge 이미지와 다른 형태적 특성을 가지고 있습니다. 이를 개선하고자, 사람들이 그린 Sketch 이미지를 모델 학습에 반영하는 MLOps 파이프라인을 구축 중에 있습니다. 데이터 기반으로 지속적인 CI/CT/CD 환경을 만들어 모델 성능을 향상시키고 서비스의 사용성을 높이고자합니다. 더불어, 온라인 전시 공간 마련을 통해 누구나 손쉽게 ML Art를 접할 수 있는 Gallery를 제작하고자 합니다. 작품과 공간이 조화롭게 구성된 Gallery를 통해 사용자가 조금 더 몰입감이 높은 분위기에서 작품을 감상할 수 있도록 구상하고 있습니다

### Reference
**[1] [Image-to-Image Translation and Applications](https://www.youtube.com/watch?v=R5wqgUDx714)**  
**[2] [Visualization and Interpretability](https://www.youtube.com/watch?v=p8ELVPIVzuM)**  
**[3] [CNN 시각화 사이트](https://data-newbie.tistory.com/507)**  
**[4] [Style Transfer](https://blog.lunit.io/2017/04/27/style-transfer)**  
**[5] [AI Production Roadmap - AI 시스템의 요구사항과 기술의 방향](https://www.youtube.com/watch?v=ZfLdURY0qCs)**  
